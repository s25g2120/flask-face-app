{% extends "base.html" %}
{% block content %}

<h1>{{ title }}</h1>

{# åå‰ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ  #}
<form action="/update_user" method="post" id="userForm">
    <div class="row mb-3">
    </div>

    {# --- ãƒ¦ãƒ¼ã‚¶ID (å¤‰æ›´ä¸å¯) --- #}
    <div class="row mb-3">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control" type="text" name="id" id="id" value="{{ user.id }}" readonly>
                <label for="id">ãƒ¦ãƒ¼ã‚¶IDï¼ˆå¤‰æ›´ä¸å¯ï¼‰</label>
            </div>
        </div>
    </div>

    {# --- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–° --- #}
    <div class="row mb-3">
        <div class="col-auto">
            <div class="form-floating position-relative">
                <input class="form-control" type="password" name="password" id="password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›...">
                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ›´æ–°ã§ã‚ã‚Œã°å…¥åŠ›ï¼‰</label>
                {# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º/éè¡¨ç¤ºãƒœã‚¿ãƒ³ #}
                <button type="button" onmousedown="showPassword()" onmouseup="hidePassword()" onmouseleave="hidePassword()" class="btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2" style="background:none; border:none; font-size:1.2rem; cursor:pointer; z-index:2;">ğŸ™ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º/éè¡¨ç¤ºç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function showPassword(){document.getElementById("password").type="text";}
        function hidePassword(){document.getElementById("password").type="password";}
    </script>

    {# --- åå‰æ›´æ–° --- #}
    <div class="row mb-3">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control" type="text" name="lastname" id="lastname" value="{{ user.lastname }}" required>
                <label for="lastname">å§“</label>
            </div>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control" type="text" name="firstname" id="firstname" value="{{ user.firstname }}" required>
                <label for="firstname">å</label>
            </div>
        </div>
    </div>

    <hr class="my-4">

    {# --- é¡”èªè¨¼å†ç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- #}
    <div class="row mt-4">
        <div class="col-12">
            <h3>é¡”èªè¨¼æƒ…å ±ã®æ›´æ–°</h3>
        </div>
    </div>

    <button type="button" id="startFaceBtn" class="btn btn-warning mb-3">æ–°ã—ã„é¡”ã‚’ç™»éŒ²</button>

    <div class="row mb-3">
        <div class="col-12 text-center">
            {# é¡”èªè¨¼ç”¨ã‚³ãƒ³ãƒ†ãƒŠ #}
            <div id="faceContainer" style="position:relative; width:400px; height:400px; margin:auto; display:none;">
                <video id="webcam" autoplay playsinline style="width:400px; height:400px;"></video>
                <canvas id="faceCanvas" width="400" height="400" style="position:absolute; top:0; left:0; border-radius:20px; pointer-events:none; z-index:999;"></canvas>
            </div>
            <p id="progressText" style="font-size:16px; margin-top:8px;">é¡”èªè¨¼é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
        </div>
    </div>
    
    <input type="hidden" id="faceImage" name="face_image_dataurl" value="">

    {# --- æ“ä½œãƒœã‚¿ãƒ³ --- #}
    <div class="row mt-4">
        <div class="col-auto">
            <input class="btn btn-primary" type="submit" id="updateSubmitBtn" value="æ›´æ–°ã—ã¦ç™»éŒ²" disabled>
        </div>
        <div class="col-auto">
            <a href="/delete_user_page" class="btn btn-danger">ãƒ¦ãƒ¼ã‚¶å‰Šé™¤</a>
        </div>
    </div>

    <a href="/" class="btn btn-link">ã‚¿ã‚¹ã‚¯ä¸€è¦§ã«æˆ»ã‚‹</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const startBtn = document.getElementById('startFaceBtn');
    const updateSubmitBtn = document.getElementById('updateSubmitBtn');
    const form = document.getElementById('userForm');
    const faceImageInput = document.getElementById('faceImage'); // hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

    const formInputs = form.querySelectorAll('input[type="text"]:not([readonly]), input[type="password"]');

    const video = document.getElementById('webcam');
    const canvas = document.getElementById('faceCanvas');
    const ctx = canvas.getContext('2d');
    const faceContainer = document.getElementById('faceContainer');
    const progressText = document.getElementById('progressText');

    // ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ï¼ˆå¤‰æ›´ç›£è¦–ç”¨ï¼‰
    const initialFormState = {};
    formInputs.forEach(input => {
        initialFormState[input.id] = input.type === 'password' ? '' : input.value;
    });

    let progress = 0;
    let stream = null;
    let faceCaptureCompleted = false; // é¡”èªè¨¼æˆåŠŸãƒ•ãƒ©ã‚°

    // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }
    
    // --- ãƒ•ã‚©ãƒ¼ãƒ å¤‰æ›´ç›£è¦–ã¨ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–ãƒ­ã‚¸ãƒƒã‚¯ ---
    function checkFormChanged() {
        let formChanged = false;
        formInputs.forEach(input => {
            const currentValue = input.type === 'password' && input.value === '' ? '' : input.value;
            if (currentValue !== initialFormState[input.id]) {
                formChanged = true;
            }
        });
        
        // ã€ä¿®æ­£ã€‘ãƒ•ã‚©ãƒ¼ãƒ å†…å®¹ã®å¤‰æ›´ã€ã¾ãŸã¯é¡”ç”»åƒãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        const faceChanged = faceImageInput.value !== '';
        updateSubmitBtn.disabled = !(formChanged || faceChanged);
        startBtn.disabled = false;
    }

    formInputs.forEach(input => {
        input.addEventListener('input', checkFormChanged);
    });
    // Hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å†…å®¹ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã‚‚ãƒœã‚¿ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ (ã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†æ™‚)
    faceImageInput.addEventListener('change', checkFormChanged); 
    checkFormChanged(); // åˆæœŸãƒã‚§ãƒƒã‚¯
    
    // --- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç† ("æ›´æ–°ã—ã¦ç™»éŒ²"ãƒœã‚¿ãƒ³) ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // å¤‰æ›´ãŒãªã„å ´åˆã¯é€ä¿¡ã—ãªã„
        if (updateSubmitBtn.disabled) {
             alert("å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
             return;
        }
        
        // é¡”æƒ…å ±ãŒã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚Œã¦ã„ã‚Œã°å³åº§ã«é€ä¿¡ã€‚ã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚Œã¦ã„ãªãã¦ã‚‚ã€åå‰/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ã¦ã„ã‚Œã°é€ä¿¡ã™ã‚‹
        submitFormWithFaceData();
    });

    // --- ã‚«ãƒ¡ãƒ©/é¡”èªè¨¼é–‹å§‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    async function startFaceAuthentication() {
        faceContainer.style.display = "block";
        faceContainer.scrollIntoView({ behavior: "smooth", block: "center" });
        updateSubmitBtn.disabled = true; 
        startBtn.disabled = true;
        progressText.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...";
        progress = 0;
        faceCaptureCompleted = false; // æ–°ã—ã„ã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹

        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                video.play();
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                requestAnimationFrame(() => drawLoop()); 
            };
        } catch(e) {
            progressText.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            checkFormChanged(); // ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            console.error(e);
        }
    }

    // --- æ–°ã—ã„é¡”ã‚’ç™»éŒ²ãƒœã‚¿ãƒ³ã®å‡¦ç† ---
    startBtn.addEventListener('click', async () => {
        // é¡”èªè¨¼ã‚’é–‹å§‹ã™ã‚‹ãŒã€å®Œäº†ã—ã¦ã‚‚è‡ªå‹•é€ä¿¡ã¯ã—ãªã„
        startFaceAuthentication(); 
    });


    // --- ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–¢æ•° (é¡”æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã‚ã‚Š) ---
    function submitFormWithFaceData() {
        progressText.textContent = "æ›´æ–°æƒ…å ±ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ä¸­...";
        
        // Hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (faceImageInput) ã®å€¤ãŒé€ä¿¡ã•ã‚Œã‚‹
        const formData = new FormData(form); 

        fetch(form.action, {
            method:'POST',
            body: formData 
        }).then(res => res.json()).then(data => {
            if (data.success) {
                alert("ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
                
                // æˆåŠŸæ™‚ã®åˆæœŸå€¤ãƒªã‚»ãƒƒãƒˆå‡¦ç†
                formInputs.forEach(input => {
                    if (input.type === 'password') {
                        initialFormState[input.id] = '';
                    } else {
                        initialFormState[input.id] = input.value;
                    }
                });
                faceImageInput.value = ''; // é¡”ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                window.location.href = data.redirect_url || "/"; 
            } else {
                alert(data.message || "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                faceCaptureCompleted = false;
                progressText.textContent = data.message || "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                checkFormChanged(); 
            }
        }).catch(err=>{
            console.error("æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
            alert("ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            faceCaptureCompleted = false;
            progressText.textContent = "ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            checkFormChanged();
        });
    }


    function drawLoop() {
        if (faceCaptureCompleted || !stream) {
            stopCamera();
            return;
        }
        
        progress = Math.min(progress + 0.01, 1);

        // --- æ˜ åƒã¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã®æç”» ---
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // æ˜ åƒã‚’æç”» (é¡é¢åè»¢)
        ctx.save();
        ctx.scale(-1,1);
        ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
        ctx.restore();

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã®æç”» (çœç•¥)
        // ... (å‰å›ã® drawLoop ã®ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°æç”»ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«æŒ¿å…¥) ...
        const cx = canvas.width/2, cy = canvas.height/2, radius = canvas.width*0.35, numBars=60;
        for(let i=0;i<numBars;i++){
            const angle = (i/numBars)*2*Math.PI - Math.PI/2;
            ctx.beginPath();
            ctx.moveTo(cx+Math.cos(angle)*radius, cy+Math.sin(angle)*radius);
            ctx.lineTo(cx+Math.cos(angle)*(radius+22), cy+Math.sin(angle)*(radius+22));
            
            if(i/numBars < progress){
                ctx.strokeStyle = "rgba(0,255,120,0.95)";
                ctx.lineWidth = 6;
                ctx.shadowColor = "rgba(0,255,120,0.9)";
                ctx.shadowBlur = 18;
            } else {
                ctx.strokeStyle = "rgba(255,255,255,0.18)";
                ctx.lineWidth = 3;
                ctx.shadowBlur = 0;
            }
            ctx.lineCap = "round";
            ctx.stroke();
        }


        progressText.textContent = `é¡”æƒ…å ±å–å¾—ä¸­... é€²æ—: ${Math.round(progress*100)}%`;

        // --- é¡”èªè¨¼å®Œäº†æ™‚ã®å‡¦ç† ---
        if(progress >= 1 && !faceCaptureCompleted){
            faceCaptureCompleted = true;
            progressText.textContent = "é¡”æƒ…å ±å–å¾—å®Œäº†ï¼ã€Œæ›´æ–°ã—ã¦ç™»éŒ²ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
            
            // æ’®å½±ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã€hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ ¼ç´
            const tmp = document.createElement('canvas');
            tmp.width = video.videoWidth;
            tmp.height = video.videoHeight;
            const tmpCtx = tmp.getContext('2d');
            tmpCtx.scale(-1,1);
            tmpCtx.drawImage(video, -tmp.width, 0, tmp.width, tmp.height);
            
            // Hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®šã—ã€changeã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¦ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            faceImageInput.value = tmp.toDataURL('image/jpeg');
            faceImageInput.dispatchEvent(new Event('change'));

            stopCamera();
            faceContainer.style.display = "none";
            
            alert("æ–°ã—ã„é¡”æƒ…å ±ãŒä¸€æ™‚çš„ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚ã€Œæ›´æ–°ã—ã¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å®Œäº†ã—ã¦ãã ã•ã„ã€‚");
        } else {
            // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¸
            requestAnimationFrame(() => drawLoop());
        }
    }
});
</script>
{% endblock content %}
{% extends "base.html" %}
{% block content %}

<h1>{{ title }}</h1>

<form id="loginForm" method="post" action="/login">
    <!-- ユーザID -->
    <div class="row mb-3">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control"
                       type="text"
                       name="id"
                       id="user_id"
                       placeholder="ユーザIDを入力..."
                       required>
                <label for="user_id">ユーザID</label>
            </div>
        </div>
    </div>

    <!-- パスワード -->
    <div class="row mb-3" id="password_div">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control"
                       type="password"
                       name="password"
                       id="password"
                       placeholder="パスワードを入力..."
                       disabled
                       required>
                <label for="password">パスワード</label>
            </div>
        </div>
    </div>

    <!-- ボタン群 -->
    <div class="row mb-3">
        <div class="col-auto">
            <button type="button"
                    class="btn btn-warning"
                    id="face_btn"
                    disabled>
                顔認証
            </button>
        </div>

        <div class="col-auto">
            <input type="submit"
                   class="btn btn-primary"
                   id="login_btn"
                   value="ログイン"
                   disabled>
            <a href="/register" class="btn btn-link">新規ユーザ登録</a>
        </div>
    </div>
</form>

<!-- 顔認証中オーバーレイ -->
<div id="faceOverlay" style="
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.7);
    color:#fff;
    font-size:24px;
    align-items:center;
    justify-content:center;
    z-index:1000;
    display:none;
">
    認証中…
</div>



<video id="webcam" autoplay style="display:none;"></video>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const userIdInput = document.getElementById("user_id");
    const faceBtn = document.getElementById("face_btn");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("login_btn");
    const video = document.getElementById("webcam");
    const overlay = document.getElementById("faceOverlay");
    const loginForm = document.getElementById("loginForm");

    // ボタン状態制御
    function updateButtonState() {
        const hasId = userIdInput.value.trim().length > 0;
        faceBtn.disabled = !hasId;
        passwordInput.disabled = !hasId;
        loginBtn.disabled = !hasId;
    }

    updateButtonState();
    userIdInput.addEventListener("input", updateButtonState);

    // カメラ起動
    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        return new Promise(resolve => {
            video.onloadedmetadata = () => resolve(stream);
        });
    }

    // カメラ停止
    function stopCamera(stream) {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    }

    // 顔認証
    faceBtn.addEventListener("click", async () => {
        overlay.style.display = "flex";
        faceBtn.disabled = true;

        let stream = null;

        try {
            stream = await startCamera();

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const blobs = [];

            for (let i = 0; i < 3; i++) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                await new Promise(resolve => {
                    canvas.toBlob(blob => {
                        blobs.push(blob);
                        resolve();
                    }, "image/jpeg");
                });
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            const formData = new FormData();
            formData.append("id", userIdInput.value.trim());
            blobs.forEach((b, i) =>
                formData.append("face_images", b, `face${i}.jpg`)
            );

            const res = await fetch("/login_face", {
                method: "POST",
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                window.location.href = data.redirect_url || "/";
            } else {
                alert("顔認証に失敗しました。パスワードでログインしてください。");
            }

        } catch (e) {
            console.error(e);
            alert("顔認証に失敗しました。パスワードでログインしてください。");
        } finally {
            stopCamera(stream);
            overlay.style.display = "none";
            updateButtonState();
        }
    });

    // パスワードログイン
    loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (passwordInput.disabled) {
            alert("顔認証を試すか、パスワードを入力してください。");
            return;
        }

        const formData = new FormData(loginForm);
        const res = await fetch("/login", {
            method: "POST",
            body: formData
        });

        const data = await res.json();
        if (data.success) {
            window.location.href = data.redirect_url || "/";
        } else {
            alert(data.message || "ログインに失敗しました");
        }
    });
});
</script>

{% endblock content %}

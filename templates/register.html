{% extends "base.html" %}
{% block content %}

<h1>{{ title }}</h1>
<form action="/register" method="post" id="userForm">
    
    {# --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ --- #}
    <div class="row mt-2">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control" type="text" name="id" id="id" placeholder="ãƒ¦ãƒ¼ã‚¶IDã‚’å…¥åŠ›..." required>
                <label for="id">ãƒ¦ãƒ¼ã‚¶ID</label>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control" type="password" name="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." required>
                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control" type="text" name="lastname" id="lastname" placeholder="å§“ã‚’å…¥åŠ›..." required>
                <label for="lastname">å§“</label>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-auto">
            <div class="form-floating">
                <input class="form-control" type="text" name="firstname" id="firstname" placeholder="åã‚’å…¥åŠ›..." required>
                <label for="firstname">å</label>
            </div>
        </div>
    </div>

    <hr class="my-3">

    {# --- é¡”èªè¨¼ç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- #}
    <div class="row mt-2">
        <div class="col-12">
            <h2>é¡”ã®ç™»éŒ²</h2>
            <button type="button" class="btn btn-warning" id="face_btn">é¡”æƒ…å ±ç™»éŒ²</button>
            <p id="progressText" style="margin-top:8px;">â€»ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™å‰ã«é¡”æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
            
            <div id="faceContainer" style="position:relative; width:320px; height:240px; margin-top:8px; display:none;">
                <video id="webcam" autoplay playsinline style="width:320px; height:240px; transform: scaleX(-1);"></video>
                <canvas id="faceCanvas" width="320" height="240" style="position:absolute; top:0; left:0; pointer-events:none;"></canvas>
            </div>
        </div>
    </div>
    
    <hr class="my-3"> {# --- ç™»éŒ²ãƒœã‚¿ãƒ³ --- #}
    <div class="row mt-4">
        <div class="col-auto">
            <input class="btn btn-primary" type="submit" value="ç™»éŒ²" id="submit_btn" disabled>
        </div>
    </div>

    <a href="/login">ç™»éŒ²æ¸ˆã¿ã®æ–¹ã¯ã“ã¡ã‚‰</a>
</form>
<script>
document.addEventListener("DOMContentLoaded", () => {
    let capturedImages = [];
    const faceBtn = document.getElementById('face_btn');
    const progressText = document.getElementById('progressText');
    const faceContainer = document.getElementById('faceContainer');
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('faceCanvas');
    const ctx = canvas.getContext('2d');
    const submitBtn = document.getElementById('submit_btn');
    const form = document.getElementById('userForm');

    let stream = null;
    let frameCount = 0;
    const totalFrames = 60; 
    
    // å¿…é ˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚¹ãƒˆ
    const requiredInputs = form.querySelectorAll('input[required]');

    // --- A. ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã®ãƒã‚§ãƒƒã‚¯é–¢æ•° ---
    function updateSubmitButtonState() {
        let allInputsFilled = true;
        requiredInputs.forEach(input => {
            if (input.value.trim() === '') {
                allInputsFilled = false;
            }
        });
        
        const faceDataReady = capturedImages.length >= 3;
        submitBtn.disabled = !(allInputsFilled && faceDataReady);
    }

    // --- B. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¨ Hidden ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´æ™‚ã«ãƒã‚§ãƒƒã‚¯ ---
    requiredInputs.forEach(input => {
        input.addEventListener('input', updateSubmitButtonState);
    });
    
    // åˆæœŸãƒã‚§ãƒƒã‚¯ (ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚)
    updateSubmitButtonState(); 

    // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®åœæ­¢é–¢æ•°
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    faceBtn.addEventListener('click', async () => {
        // ... (ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—) ...
        faceContainer.style.display = "block";
        faceBtn.disabled = true;
        progressText.textContent = "é¡”ã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„ (æ’®å½±ä¸­...)";
        faceContainer.scrollIntoView({ behavior: "smooth", block: "center" });
        
        frameCount = 0;
        updateSubmitButtonState(); // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–

        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            await video.play(); 
            requestAnimationFrame(drawLoop);
        } catch (e) {
            console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", e);
            progressText.textContent = "ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            faceBtn.disabled = false;
            faceContainer.style.display = "none";
        }
    });

    // --- C. æç”»ãƒ«ãƒ¼ãƒ— ---
    function drawLoop() {
        if (capturedImages.length >= 3 || !stream) return;
 // æ—¢ã«å®Œäº†ã—ã¦ã„ãŸã‚‰çµ‚äº†

        const cx = canvas.width/2, cy = canvas.height/2, radius = 100, numBars = totalFrames;
        const progress = frameCount / totalFrames;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ğŸŒŸ ä¿®æ­£ç‚¹1: ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ã™ã‚‹éš›ã€é¡é¢åè»¢ã‚’é©ç”¨ã™ã‚‹
        ctx.save();
        ctx.scale(-1, 1);
        ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height); 
        ctx.restore();

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã®æç”»
        for(let i=0; i < numBars; i++){
            const angle = (i/numBars)*2*Math.PI - Math.PI/2;
            ctx.beginPath();
            ctx.moveTo(cx + Math.cos(angle)*radius, cy + Math.sin(angle)*radius);
            ctx.lineTo(cx + Math.cos(angle)*(radius+15), cy + Math.sin(angle)*(radius+15));
            ctx.strokeStyle = (i/numBars < progress) ? "rgba(0,255,120,0.9)" : "rgba(255,255,255,0.2)";
            ctx.lineWidth = 4;
            ctx.stroke();
        }

        frameCount++;
        
        if (frameCount >= totalFrames) {
            // æ’®å½±å®Œäº†
            progressText.textContent = "é¡”æƒ…å ±å–å¾—å®Œäº†ï¼";

            capturedImages = [];

            // â˜… åŒã˜æ˜ åƒã‹ã‚‰3æšç”Ÿæˆï¼ˆUIãã®ã¾ã¾ï¼‰
            for (let i = 0; i < 3; i++) {
                const tmpCanvas = document.createElement('canvas');
                tmpCanvas.width = canvas.width;
                tmpCanvas.height = canvas.height;
                const tmpCtx = tmpCanvas.getContext('2d');

                tmpCtx.scale(-1, 1);
                tmpCtx.drawImage(video, -tmpCanvas.width, 0, tmpCanvas.width, tmpCanvas.height);

                capturedImages.push(tmpCanvas.toDataURL('image/jpeg'));
            }

            // â˜… æ—¢å­˜ hidden input ã‚’å‰Šé™¤
            document.querySelectorAll('input[name="face_data[]"]').forEach(e => e.remove());

            // â˜… 3æšåˆ† hidden input ã‚’è¿½åŠ 
            capturedImages.forEach(img => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'face_data[]';
                input.value = img;
                form.appendChild(input);
            });

            stopCamera();
            faceContainer.style.display = "none";
            faceBtn.disabled = false;

            submitBtn.disabled = false;
            submitBtn.scrollIntoView({ behavior: "smooth", block: "center" });

        } else {
            requestAnimationFrame(drawLoop);
        }

    }
});
</script>
{% endblock content %}